<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de Facturas Pro+</title>
  <link rel="icon" type="image/png" href="img/favicon.png">
  <link rel="apple-touch-icon" href="img/favicon.png">
  <description>Generador de Facturas Intranet  - Crea y administra tus facturas f√°cilmente.</description>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, addDoc, setDoc, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyCxQXa5p6nMdNnoMg8WovFKpPAkswtsq_M",
      authDomain: "facturapro-77a90.firebaseapp.com",
      projectId: "facturapro-77a90",
      storageBucket: "facturapro-77a90.appspot.com",
      messagingSenderId: "1007059008367",
      appId: "1:1007059008367:web:31423329d4d3740a33469a",
      measurementId: "G-JS33JQ3SK0"
    };
  
    const app = initializeApp(firebaseConfig);
    window.auth = getAuth(app);
    window.db = getFirestore(app);
    window.firebase = {
        collection, getDocs, doc, getDoc, addDoc, setDoc, deleteDoc, updateDoc, writeBatch,
        signInWithEmailAndPassword, signOut, sendPasswordResetEmail, updatePassword
    };
  </script>

  <style>
    :root {
      --bg: #f7f9fc;
      --card: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --primary-light: #eff6ff;
      --accent: #111827;
      --line: #e5e7eb;
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --info: #3b82f6;
      --sidebar-bg: #111827;
      --sidebar-ink: #d1d5db;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); 
      color: var(--ink);
      font-size: 14px;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #login-wall {
      position: fixed;
      inset: 0;
      background-color: rgba(247, 249, 252, 0.8);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      transition: opacity 0.3s ease;
    }
    
    .login-box {
      background: rgba(255, 255, 255, 0.8);
      padding: 2.5rem;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.9);
      box-shadow: var(--shadow-lg);
      text-align: center;
      width: 90%;
      max-width: 400px;
      animation: slideUp 0.5s ease;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .login-box h3 { margin: 0 0 0.5rem 0; font-size: 1.75rem; color: var(--ink); font-weight: 700; }
    .login-box p { margin: 0 0 1.5rem 0; color: var(--muted); }
    
    .login-input {
      width: 100%; padding: 0.85rem 1rem; border: 1px solid var(--line);
      border-radius: var(--radius); background: #fff; color: var(--ink);
      outline: none; transition: var(--transition); font-size: 1rem; margin-bottom: 1rem;
    }
    
    .login-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); }
    
    #login-button {
      width: 100%; padding: 0.85rem; font-size: 1rem; background: var(--primary);
      border: none; color: #fff; border-radius: var(--radius); cursor: pointer;
      font-weight: 600; transition: var(--transition);
    }
    
    #login-button:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow); }
    #login-button:disabled { background: var(--muted); cursor: not-allowed; }
    
    .login-error-message {
      margin-top: 1rem !important; color: var(--danger) !important; display: none;
      background: rgba(239, 68, 68, 0.1); padding: 0.75rem; border-radius: var(--radius);
    }

    #recover-password-button {
        background: none; border: none; color: var(--primary); font-size: 0.875rem;
        cursor: pointer; margin-top: 1.5rem; padding: 0.5rem;
    }
    #recover-password-button:hover { text-decoration: underline; }

    .app-layout { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
    
    .sidebar {
      background: var(--sidebar-bg); color: var(--sidebar-ink); padding: 1.5rem;
      display: flex; flex-direction: column; height: 100vh;
      overflow-y: auto; border-right: 1px solid var(--line);
    }
    
    .sidebar h1 {
      font-size: 1.5rem; color: #fff; margin: 0 0 2.5rem 0;
      display: flex; align-items: center; gap: 0.75rem; font-weight: 700;
    }
    
    .sidebar-nav { display: flex; flex-direction: column; gap: 0.5rem; }
    
    .sidebar-nav a {
      display: flex; align-items: center; gap: 0.75rem; padding: 0.85rem 1rem;
      border-radius: var(--radius); color: var(--sidebar-ink); text-decoration: none;
      font-weight: 500; transition: var(--transition);
    }
    
    .sidebar-nav a:hover { background: #1f2937; color: #fff; }
    .sidebar-nav a.active { background: var(--primary); color: #fff; font-weight: 600; }
    .sidebar-nav a svg { width: 1.25rem; height: 1.25rem; }
    .sidebar-footer { margin-top: auto; font-size: 0.8rem; color: #6b7280; padding-top: 1.5rem; text-align: center; }
    .main-content { padding: 2.5rem; }
    .page { display: none; animation: fadeIn 0.4s ease-in-out; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .page.active { display: block; }
    
    .page-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 2rem; gap: 1rem; flex-wrap: wrap;
    }
    
    .page-header h2 { margin: 0; font-size: 2rem; display: flex; align-items: center; gap: 0.75rem; font-weight: 800; }
    .toolbar { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .grid { display: grid; gap: 1.75rem; }
    .cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }

    .card {
      background: var(--card); border: 1px solid var(--line); border-radius: var(--radius);
      padding: 1.75rem; box-shadow: var(--shadow); transition: var(--transition);
    }

    .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .card h3 { margin: 0 0 1.25rem 0; font-size: 1.25rem; font-weight: 700; }
    
    .stat-card { text-align: center; padding: 1.5rem; }
    .stat-card .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary); margin-bottom: 0.25rem; }
    .stat-card .stat-label { font-size: 0.9rem; color: var(--muted); font-weight: 500; }
    
    label { font-size: 0.875rem; font-weight: 500; color: var(--muted); display: block; margin-bottom: 0.5rem; }
    
    input, select, textarea {
      width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--line); border-radius: var(--radius);
      background: var(--bg); color: var(--ink); outline: none; transition: var(--transition); font-size: 0.9rem;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary); background: var(--card); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }
    
    textarea { resize: vertical; min-height: 6rem; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; }
    
    .btn {
      appearance: none; border: 1px solid transparent; padding: 0.75rem 1.25rem;
      border-radius: var(--radius); cursor: pointer; font-weight: 600; display: inline-flex;
      align-items: center; justify-content: center; gap: 0.5rem; transition: var(--transition); font-size: 0.875rem;
    }
    
    .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
    .btn.primary { background: var(--primary); border-color: var(--primary); color: #fff; }
    .btn.secondary { background: var(--primary-light); color: var(--primary-dark); border-color: transparent; }
    .btn.secondary:hover { background: #dbeafe; }
    .btn.ghost { border-color: var(--line); background: var(--card); color: var(--ink); }
    .btn.ghost:hover { background: var(--bg); border-color: var(--muted); }
    .btn.danger { background: var(--danger); border-color: var(--danger); color: #fff; }
    .btn.success { background: var(--success); border-color: var(--success); color: #fff; }
    .btn:disabled { opacity: .6; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-sm { padding: 0.5rem 0.85rem; font-size: 0.8rem; }
    .btn-icon { padding: 0.6rem; }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--line); padding: 1rem 0.75rem; text-align: left; font-size: 0.9rem; vertical-align: middle; }
    th { color: var(--muted); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: .05em; }
    tbody tr:hover { background: var(--primary-light); }
    .right { text-align: right; }
    
    .badge {
      display: inline-block;
      padding: 0.3rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    .badge-success { background-color: var(--success); color: white; }
    .badge-warning { background-color: var(--warning); color: var(--ink); }
    .badge-info { background-color: var(--info); color: white; }
    .badge-danger { background-color: var(--danger); color: white; }
    .badge-muted { background-color: var(--line); color: var(--muted); }
    
    .table-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(17, 24, 39, 0.6); z-index: 100;
      display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(8px); animation: fadeIn 0.3s ease;
    }
    
    .modal-box {
      background: var(--card); border-radius: var(--radius); padding: 2rem; width: 90%;
      max-width: 550px; box-shadow: var(--shadow-lg); max-height: 90vh; overflow-y: auto;
      animation: slideUp 0.4s ease;
    }
     .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .modal-header h3 { margin: 0; font-size: 1.5rem; font-weight: 700; }

    .toast {
      position: fixed; bottom: 1.5rem; right: 1.5rem; background: var(--accent); color: #fff;
      padding: 1rem 1.5rem; border-radius: var(--radius); z-index: 300; font-weight: 500;
      opacity: 0; transform: translateY(20px); transition: var(--transition);
      box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 0.75rem;
    }
    
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    .toast.warning { background: var(--warning); }
    
    footer { text-align: center; padding: 0.75rem; background: var(--bg); font-size: 0.8rem; color: var(--muted); border-top: 1px solid var(--line); grid-column: 1 / 3; }
    .hr { height: 1px; background: var(--line); margin: 2rem 0; border: none; }
    .mini { font-size: 0.85rem; color: var(--muted); }
    .total-box { background: var(--primary-light); border-radius: var(--radius); padding: 1.5rem; }
    .product-adder-grid { display: grid; grid-template-columns: 1fr 80px 120px; gap: 8px; }
    .logo-preview {
      width: 140px; height: 80px; max-width: 100%; max-height: 80px; object-fit: contain;
      border: 2px dashed var(--line); border-radius: var(--radius); background: var(--bg); padding: 0.5rem; display: block;
    }
    .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.75rem; }
    .search-box { position: relative; max-width: 250px; }
    .search-box input { padding-left: 2.5rem; }
    .search-box svg { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); width: 1.25rem; height: 1.25rem; color: var(--muted); }
    .confirm-modal { text-align: center; }
    .confirm-modal .btn { min-width: 100px; margin: 0 0.5rem; }
    
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 95;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem;
      cursor: pointer;
    }
    .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background-color: rgba(0,0,0,0.5);
        z-index: 80;
    }
    .sidebar-overlay.active { display: block; }


    @media (max-width: 1024px) {
      .app-layout { grid-template-columns: 1fr; }
      .sidebar { 
        position: fixed; left: -260px; transition: left 0.3s ease; 
        z-index: 90; width: 260px; height: 100vh;
      }
      .sidebar.active { left: 0; box-shadow: var(--shadow-lg); }
      .main-content { margin-left: 0; width: 100%; }
      .cols-3, .cols-2, .cols-4, .row { grid-template-columns: 1fr; }
      .mobile-menu-btn { display: block; }
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a; --card: #1e293b; --ink: #f8fafc;
        --muted: #94a3b8; --line: #334155; --sidebar-bg: #0b1120;
      }
      input, select, textarea { background: #0f172a; color: var(--ink); border-color: var(--line); }
      input:focus, select:focus, textarea:focus { background: var(--card); }
      #login-wall { background-color: rgba(15, 23, 42, 0.8); }
      .login-box { background: rgba(30, 41, 59, 0.8); border-color: rgba(51, 65, 85, 0.9); }
      .total-box { background: #0f172a; border: 1px solid var(--line); }
    }
  </style>
</head>
<body>
  
  <button class="mobile-menu-btn" id="mobileMenuButton">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
  </button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div id="login-wall">
    <div class="login-box">
      <h3>Iniciar Sesi√≥n</h3>
      <p>Ingresa tus credenciales para acceder al facturador.</p>
      <input type="email" id="login-email" class="login-input" placeholder="Correo Electr√≥nico" required />
      <input type="password" id="login-password" class="login-input" placeholder="Contrase√±a" required />
      <button id="login-button">Entrar</button>
      <p id="login-error" class="login-error-message">Credenciales incorrectas.</p>
      <button id="recover-password-button">¬øOlvidaste tu contrase√±a?</button>
    </div>
  </div>

  <div class="app-layout">
    <aside class="sidebar">
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.5 2H8.6c-.4 0-.8.2-1.1.5-.3.3-.5.7-.5 1.1V21c0 .6.4 1 1 1h12c.6 0 1-.4 1-1V6.5L15.5 2z"></path><path d="M15 2v5h5"></path><path d="M10 16s-1-2-3-2-3 2-3 2"></path><path d="M10 12s-1-2-3-2-3 2-3 2"></path><path d="M18 16s-1-2-3-2-3 2-3 2"></path><path d="M18 12s-1-2-3-2-3 2-3 2"></path></svg>
            <span>Facturador Pro+</span>
        </h1>
   
        <nav class="sidebar-nav">
            <a href="#dashboard" class="nav-link active">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
                <span>Dashboard</span>
            </a>
            <a href="#factura" class="nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                <span>Nueva Factura</span>
            </a>
            <a href="#cotizacion" class="nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                <span>Nueva Cotizaci√≥n</span>
            </a>
           <a href="#historial" class="nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                <span>Historial</span>
            </a>
            <a href="#clientes" class="nav-link">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span>Clientes</span>
            </a>
            <a href="#productos" class="nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                <span>Productos</span>
            </a>
            <a href="#config" class="nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                <span>Configuraci√≥n</span>
            </a>
            <a href="#" class="nav-link" id="logout-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                <span>Cerrar Sesi√≥n</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <p>Datos en la nube con Firebase.</p>
        </div>
    </aside>

    <main class="main-content">
      <section id="page_dashboard" class="page active">
        <div class="page-header">
          <h2>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
            <span>Dashboard</span>
          </h2>
        </div>
        <div class="grid cols-4" id="dashboard-stats">
          <div class="card stat-card">
            <div id="stat-total-paid" class="stat-value">$0</div>
            <div class="stat-label">Total Cobrado</div>
          </div>
          <div class="card stat-card">
            <div id="stat-total-pending" class="stat-value">$0</div>
            <div class="stat-label">Pendiente de Cobro</div>
          </div>
          <div class="card stat-card">
            <div id="stat-total-clients" class="stat-value">0</div>
            <div class="stat-label">Clientes Activos</div>
          </div>
          <div class="card stat-card">
            <div id="stat-total-invoices" class="stat-value">0</div>
            <div class="stat-label">Facturas Emitidas</div>
          </div>
        </div>
        <div class="card" style="margin-top: 2rem;">
            <h3>Actividad Reciente</h3>
            <table id="tablaActividadReciente">
              <thead>
                <tr>
                    <th># Documento</th><th>Tipo</th><th>Cliente</th><th class="right">Total</th><th class="right">Fecha</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="5" style="text-align:center; color: var(--muted);">Cargando actividad...</td></tr>
              </tbody>
            </table>
        </div>
      </section>

      <section id="page_factura" class="page">
        <div class="page-header">
          <h2>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            <span>Crear Nueva Factura</span>
          </h2>
          <div class="toolbar">
              <button class="btn secondary" id="btnNuevaFactura">‚ûï Nueva</button>
              <button class="btn danger" id="btnLimpiarFactura">üóëÔ∏è Limpiar</button>
          </div>
        </div>
        
        <div class="card" id="invoice-print-area">
            <div class="grid cols-2">
               <div>
                    <label>Elegir cliente para la factura</label>
                    <select id="selCliente"></select>
                </div>
                <div>
                <label>Agregar producto/servicio</label>
                    <div class="product-adder-grid">
                        <select id="selProducto"></select>
                        <input id="selCantidad" type="number" min="1" step="1" value="1" />
                        <button class="btn primary" id="btnAgregarItemFactura">A√±adir</button>
              </div>
                </div>
            </div>
            
            <hr class="hr" />

            <div class="grid cols-3" style="gap: 16px;">
                <div style="grid-column: 1 / 2;">
                    <div class="row">
                        <div>
                            <label>N√∫mero de Factura</label>
                            <input id="fc_num" placeholder="Autogenerado" readonly/>
                        </div>
                        <div>
                            <label>Fecha</label>
                            <input id="fc_fecha" type="date" />
                        </div>
                    </div>
                </div>
                <div>
                    <label>Descuento</label>
                    <div style="display:grid; grid-template-columns: 1fr 100px; gap:8px;">
                        <select id="fc_desc_tipo">
                            <option value="porcentaje">Porcentaje (%)</option>
                            <option value="fijo">Valor Fijo ($)</option>
                        </select>
                        <input id="fc_desc_valor" type="number" min="0" step="0.01" value="0" />
                    </div>
                </div>
                <div>
                   <label>IVA (%)</label>
                    <input id="fc_iva" type="number" min="0" step="0.01" value="0" />
                </div>
            </div>

            <table style="margin-top:20px;">
                <thead>
                   <tr>
                        <th style="width:110px">C√≥digo</th>
                        <th>Producto / Servicio</th>
                        <th>Descripci√≥n</th>
                        <th class="right" style="width:80px">Cant.</th>
                        <th class="right" style="width:110px">V. Unit</th>
                        <th class="right" style="width:120px">Total</th>
                        <th style="width:40px"></th>
                    </tr>
                </thead>
                <tbody id="items"></tbody>
            </table>
            
            <div class="grid cols-2" style="margin-top:16px; align-items:start;">
                <div>
                    <label>Notas</label>
                    <textarea id="fc_notas" placeholder="Condiciones, forma de pago, etc." rows="4"></textarea>
                </div>
                  <div>
                    <div id="previewCliente" class="mini card" style="padding:16px; min-height:100px;"></div>
                    <div class="total-box" style="margin-top:10px;">
                        <div style="display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center">
                            <span>Subtotal</span>
                            <span class="right" id="subtotal">$0</span>
                            <span>Descuento</span>
                            <span class="right" id="descuento" style="color: var(--success);">- $0</span>
                            <span>IVA</span>
                            <span class="right" id="iva">$0</span>
                            <span style="font-weight:700">Total</span>
                            <span class="right" id="total" style="font-weight:800; font-size: 1.2em">$0</span>
                        </div>
                     </div>
                </div>
            </div>

            <div class="toolbar" style="margin-top:24px; justify-content:flex-end; flex-direction:row;">
                <button class="btn secondary" id="btnEnviarFactura">üìß Enviar</button>
                <button class="btn ghost" id="btnGuardarFactura">üß∑ Guardar y Generar PDF</button>
                <button class="btn ghost" id="btnPrintInvoice">üñ®Ô∏è Imprimir</button>
                
            </div>
        </div>
      </section>

      <section id="page_cotizacion" class="page">
        <div class="page-header">
          <h2>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            <span>Crear Nueva Cotizaci√≥n</span>
          </h2>
          <div class="toolbar">
              <button class="btn secondary" id="btnNuevaCotizacion">‚ûï Nueva</button>
              <button class="btn danger" id="btnLimpiarCotizacion">üóëÔ∏è Limpiar</button>
          </div>
        </div>
        
        <div class="card" id="quote-print-area">
            <div class="grid cols-2">
               <div>
                    <label>Elegir cliente para la cotizaci√≥n</label>
                    <select id="selClienteCotizacion"></select>
                </div>
                <div>
                <label>Agregar producto/servicio</label>
                    <div class="product-adder-grid">
                        <select id="selProductoCotizacion"></select>
                        <input id="selCantidadCotizacion" type="number" min="1" step="1" value="1" />
                        <button class="btn primary" id="btnAgregarItemCotizacion">A√±adir</button>
                    </div>
                </div>
            </div>
            
            <hr class="hr" />

            <div class="grid cols-3" style="gap: 16px;">
                <div style="grid-column: 1 / 2;">
                    <div class="row">
                        <div>
                            <label>N√∫mero de Cotizaci√≥n</label>
                            <input id="ct_num" placeholder="Autogenerado" readonly/>
                        </div>
                        <div>
                            <label>Fecha</label>
                            <input id="ct_fecha" type="date" />
                        </div>
                    </div>
                </div>
                <div>
                    <label>Descuento</label>
                    <div style="display:grid; grid-template-columns: 1fr 100px; gap:8px;">
                        <select id="ct_desc_tipo">
                            <option value="porcentaje">Porcentaje (%)</option>
                            <option value="fijo">Valor Fijo ($)</option>
                        </select>
                        <input id="ct_desc_valor" type="number" min="0" step="0.01" value="0" />
                    </div>
                </div>
                <div>
                   <label>IVA (%)</label>
                    <input id="ct_iva" type="number" min="0" step="0.01" value="0" />
                </div>
            </div>

            <table style="margin-top:20px;">
                <thead>
                   <tr>
                        <th style="width:110px">C√≥digo</th>
                        <th>Producto / Servicio</th>
                        <th>Descripci√≥n</th>
                        <th class="right" style="width:80px">Cant.</th>
                        <th class="right" style="width:110px">V. Unit</th>
                        <th class="right" style="width:120px">Total</th>
                        <th style="width:40px"></th>
                    </tr>
                </thead>
                <tbody id="itemsCotizacion"></tbody>
            </table>
            
            <div class="grid cols-2" style="margin-top:16px; align-items:start;">
                <div>
                    <label>Notas</label>
                    <textarea id="ct_notas" placeholder="Condiciones, forma de pago, etc." rows="4"></textarea>
                </div>
                  <div>
                    <div id="previewClienteCotizacion" class="mini card" style="padding:16px; min-height:100px;"></div>
                    <div class="total-box" style="margin-top:10px;">
                        <div style="display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center">
                            <span>Subtotal</span>
                            <span class="right" id="subtotalCotizacion">$0</span>
                            <span>Descuento</span>
                            <span class="right" id="descuentoCotizacion" style="color: var(--success);">- $0</span>
                            <span>IVA</span>
                            <span class="right" id="ivaCotizacion">$0</span>
                            <span style="font-weight:700">Total</span>
                            <span class="right" id="totalCotizacion" style="font-weight:800; font-size: 1.2em">$0</span>
                        </div>
                     </div>
                </div>
            </div>

            <div class="toolbar" style="margin-top:24px; justify-content:flex-end; flex-direction: row;">
                <button class="btn secondary" id="btnEnviarCotizacion">üìß Enviar</button>
                <button class="btn ghost" id="btnGuardarCotizacion">üß∑ Guardar y Generar PDF</button>
                <button class="btn ghost" id="btnPrintQuote">üñ®Ô∏è Imprimir</button>
            </div>
        </div>
      </section>

      <section id="page_historial" class="page">
         <div class="page-header">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                <span>Historial</span>
            </h2>
            <div class="toolbar">
                <div class="search-box">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                  <input type="text" id="searchHistorial" placeholder="Buscar..." />
                </div>
            </div>
        </div>
        <div class="card">
            <h3>Facturas</h3>
              <table id="tablaFacturas">
              <thead>
                  <tr>
                    <th># Factura</th><th>Fecha</th><th>Cliente</th><th class="right">Total</th><th>Estado</th><th class="right" style="width:300px;">Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
          </table>
        </div>
        <div class="card" style="margin-top: 2rem;">
            <h3>Cotizaciones</h3>
              <table id="tablaCotizaciones">
              <thead>
                  <tr>
                    <th># Cotizaci√≥n</th><th>Fecha</th><th>Cliente</th><th class="right">Total</th><th class="right" style="width:280px;">Acciones</th>
                  </tr>
              </thead>
              <tbody></tbody>
          </table>
        </div>
    </section>

    <section id="page_clientes" class="page">
          <div class="page-header">
              <h2>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span>Gesti√≥n de Clientes</span>
             </h2>
              <div class="toolbar">
                <div class="search-box">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                  <input type="text" id="searchClientes" placeholder="Buscar clientes..." />
                </div>
                <button class="btn primary" id="btnNuevoCliente">‚ûï Agregar Cliente</button>
              </div>
          </div>
          <div class="card">
            <table id="tablaClientes">
                <thead>
                    <tr><th>Nombre</th><th>NIT</th><th>Tel√©fono</th><th>Correo</th><th style="width:150px;" class="right">Acciones</th></tr>
                </thead>
                <tbody></tbody>
            </table>
          </div>
      </section>

      <section id="page_productos" class="page">
          <div class="page-header">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                <span>Gesti√≥n de Productos/Servicios</span>
             </h2>
            <div class="toolbar">
              <div class="search-box">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="searchProductos" placeholder="Buscar productos..." />
              </div>
              <button class="btn primary" id="btnNuevoProducto">‚ûï Agregar Producto</button>
            </div>
        </div>
        <div class="card">
            <table id="tablaProductos">
                <thead>
                   <tr><th>C√≥digo</th><th>Nombre</th><th>Valor Unitario</th><th>Descripci√≥n (vi√±etas)</th><th style="width:150px;" class="right">Acciones</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
      </section>

      <section id="page_config" class="page">
        <div class="page-header">
             <h2>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                <span>Configuraci√≥n</span>
            </h2>
        </div>
           <div class="config-grid">
            <div class="card">
                <h3>Datos del Emisor</h3>
                <div class="row">
                    <div>
                <label>Nombre / Raz√≥n Social</label>
                        <input id="em_nombre" placeholder="Ej. Choc√≥ Creativo SAS" />
                    </div>
                    <div>
                        <label>NIT</label>
                        <input id="em_nit" placeholder="Ej. 900123456-7" />
                    </div>
                    <div>
                        <label>Direcci√≥n</label>
                        <input id="em_dir" placeholder="Calle 1 #2-34" />
                      </div>
                    <div>
                        <label>Tel√©fono</label>
                        <input id="em_tel" placeholder="+57 3xx xxx xxxx" />
                    </div>
                </div>
                <div style="margin-top:16px;">
                    <label>Correo</label>
                    <input id="em_mail" placeholder="facturacion@empresa.com" />
                </div>
                <div style="margin-top:16px;">
                    <label>Logo (opcional)</label>
                    <div style="display:flex; align-items:flex-end; gap:16px;">
                        <img id="logoPreview" class="logo-preview" alt="logo preview" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTQwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNDAiIGhlaWdodD0iODAiIGZpbGw9IiNGM0Y0RjYiIHJ4PSI4Ii8+PHN2ZyB4PSI1MCIgeT0iMjUiIHdpZHRoPSI0MCIgaGVpZHRoPSIzMCIgdmlld0JveD0iMCAwIDI0IDI4IiBmaWxsPSJub25lIiBzdHJva2U9IiM5Q0EwQUIiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTUgM0g2YTIgMiAwIDAgMC0yIDJ2MTRhMiAyIDAgMCAwIDIgMmgxMmEyIDIgMCAwIDAgMi0yVjlabTAgNGg0YTIgMiAwIDAgMSAyIDJ2MGEyIDIgMCAwIDEtMiAyaC00YTIgMiAwIDAgMS0yLTJ2MGEyIDIgMCAwIDEgMi0yeiIvPjwvc3ZnPjx0ZXh0IHg9IjcwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIiBmaWxsPSIjOUNBMEFCIj5Mb2dvIGRlIGxhIGVtcHJlc2E8L3RleHQ+PC9zdmc+" />
                        <input type="file" id="em_logo" accept="image/*" style="display:none;" />
                        <button class="btn secondary" onclick="$('#em_logo').click()">Subir Logo</button>
                    </div>
                </div>
                  <div class="toolbar" style="margin-top:24px;">
                    <button class="btn primary" id="btnGuardarEmisor">Guardar Emisor</button>
                </div>
            </div>
            
            <div class="card">
                <h3>Base de Datos Local</h3>
                <p class="mini">Importa y exporta datos desde y hacia archivos Excel.</p>
                <div class="toolbar" style="flex-direction:column; align-items:stretch; gap:12px; margin-top:20px;">
                    <button class="btn ghost" id="btnImportExcel">üì• Importar desde Excel</button>
                    <button class="btn secondary" id="btnPlantilla">üìÑ Descargar Plantilla</button>
                </div>
                <input type="file" id="inputExcel" accept=".xlsx,.xls" style="display:none" />
            </div>

            <div class="card">
                <h3>Seguridad de la Cuenta</h3>
                <p class="mini">Cambia la contrase√±a de acceso a tu cuenta.</p>
                <div style="margin-top:16px;">
                    <label>Nueva Contrase√±a</label>
                    <input type="password" id="new-password" placeholder="M√≠nimo 6 caracteres" />
                </div>
                <div style="margin-top:16px;">
                    <label>Confirmar Nueva Contrase√±a</label>
                    <input type="password" id="confirm-password" placeholder="Repite la contrase√±a" />
                </div>
                <div class="toolbar" style="margin-top:24px;">
                    <button class="btn primary" id="btnCambiarPassword">Cambiar Contrase√±a</button>
                </div>
            </div>

        </div>
      </section>

    </main>
  </div>
  
  <div id="modalCliente" class="modal-overlay">
      <div class="modal-box">
          <div class="modal-header">
            <h3 id="modalClienteTitle">Agregar Cliente</h3>
            <button class="btn ghost btn-icon" onclick="document.getElementById('modalCliente').style.display='none'">&times;</button>
          </div>
          <input type="hidden" id="cl_edit_id">
          <div class="row">
            <div><label>Nombre</label><input id="cl_nombre" /></div>
                <div><label>NIT</label><input id="cl_nit" /></div>
            <div><label>Direcci√≥n</label><input id="cl_dir" /></div>
            <div><label>Tel√©fono</label><input id="cl_tel" /></div>
          </div>
          <div style="margin-top:16px"><label>Correo</label><input id="cl_mail" /></div>
          <div class="toolbar" style="margin-top:24px; justify-content:flex-end">
            <button class="btn ghost" onclick="document.getElementById('modalCliente').style.display='none'">Cancelar</button>
            <button class="btn primary" id="btnGuardarCliente">Guardar Cliente</button>
          </div>
      </div>
  </div>

  <div id="modalProducto" class="modal-overlay">
      <div class="modal-box">
          <div class="modal-header">
            <h3 id="modalProductoTitle">Agregar Producto</h3>
            <button class="btn ghost btn-icon" onclick="document.getElementById('modalProducto').style.display='none'">&times;</button>
          </div>
          <input type="hidden" id="pr_edit_id">
          <div class="row">
            <div><label>C√≥digo</label><input id="pr_cod" /></div>
            <div><label>Nombre</label><input id="pr_nom" /></div>
          </div>
          <div style="margin-top:16px"><label>Valor Unitario</label><input id="pr_val" type="number" min="0" step="0.01" /></div>
          <div style="margin-top:16px"><label>Descripci√≥n con vi√±etas (una por l√≠nea)</label><textarea id="pr_bullets" placeholder="‚Ä¢ Punto 1\n‚Ä¢ Punto 2" rows="3"></textarea></div>
          <div class="toolbar" style="margin-top:24px; justify-content:flex-end">
            <button class="btn ghost" onclick="document.getElementById('modalProducto').style.display='none'">Cancelar</button>
            <button class="btn primary" id="btnGuardarProducto">Guardar Producto</button>
          </div>
      </div>
  </div>

  <div id="modalConfirmacion" class="modal-overlay">
      <div class="modal-box confirm-modal">
          <div class="modal-header">
            <h3 id="modalConfirmacionTitle">Confirmar acci√≥n</h3>
            <button class="btn ghost btn-icon" onclick="document.getElementById('modalConfirmacion').style.display='none'">&times;</button>
          </div>
          <p id="modalConfirmacionMensaje">¬øEst√°s seguro de que deseas realizar esta acci√≥n?</p>
          <div class="toolbar" style="margin-top:24px; justify-content:center">
            <button class="btn ghost" onclick="document.getElementById('modalConfirmacion').style.display='none'">Cancelar</button>
            <button class="btn danger" id="btnConfirmarAccion">Confirmar</button>
          </div>
      </div>
  </div>

  <div id="toast" class="toast"></div>
  <div id="qrcode-container" style="display: none;"></div>
  <footer>Desarrollado por Choc√≥ Creativo üñ§ - Conectado a Firebase</footer>

  <script type="module">
    const $ = (q) => document.querySelector(q);
    const $$ = (q) => Array.from(document.querySelectorAll(q));
    
    const { collection, getDocs, doc, getDoc, addDoc, setDoc, deleteDoc, updateDoc, writeBatch, sendPasswordResetEmail, updatePassword } = window.firebase;
    const db = window.db;
    const auth = window.auth;

    const DEFAULT_DB = {
      Emisor: { nombre: '', nit: '', direccion: '', telefono: '', correo: '', logo: '' },
      Clientes: [], Productos: [], Facturas: [], Cotizaciones: [],
      Config: {}
    };
    let DB = structuredClone(DEFAULT_DB);
    let FACT = {};
    let COTIZACION = {};
    let confirmacionCallback = null;

    async function loadDB() {
        showToast('Cargando datos desde la nube...', 'warning');
        try {
            const [clientesSnap, productosSnap, facturasSnap, cotizacionesSnap, emisorDoc] = await Promise.all([
                getDocs(collection(db, "Clientes")),
                getDocs(collection(db, "Productos")),
                getDocs(collection(db, "Facturas")),
                getDocs(collection(db, "Cotizaciones")),
                getDoc(doc(db, "Configuracion", "Emisor")),
            ]);

            DB.Clientes = clientesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            DB.Productos = productosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            DB.Facturas = facturasSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            DB.Cotizaciones = cotizacionesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            if(emisorDoc.exists()) DB.Emisor = emisorDoc.data();
            
            paintAll();
            setupSearch();
            showToast('Datos cargados correctamente ‚úÖ', 'success');
        } catch (e) {
            console.error("Error al cargar datos: ", e);
            showToast('Error al cargar datos. Revisa la conexi√≥n.', 'error');
            throw e; 
        }
    }

    async function intentarLogin() {
        const email = $('#login-email').value;
        const password = $('#login-password').value;
        const loginButton = $('#login-button');
        const loginError = $('#login-error');

        loginError.style.display = 'none';

        if (!email || !password) {
            loginError.textContent = 'Por favor, ingresa correo y contrase√±a.';
            loginError.style.display = 'block';
            return;
        }

        loginButton.disabled = true;
        loginButton.textContent = 'Verificando...';
        
        try {
            await firebase.signInWithEmailAndPassword(auth, email, password);
            $('#login-wall').style.opacity = 0;
            setTimeout(() => $('#login-wall').style.display = 'none', 300);
            await loadDB();
        } catch (error) {
            switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    loginError.textContent = 'El correo o la contrase√±a son incorrectos.';
                    break;
                case 'auth/too-many-requests':
                    loginError.textContent = 'Acceso bloqueado temporalmente. Intenta m√°s tarde.';
                    break;
                default:
                    loginError.textContent = 'Ocurri√≥ un error al iniciar sesi√≥n.';
                    console.error("Error de autenticaci√≥n:", error);
            }
            loginError.style.display = 'block';
        } finally {
            loginButton.disabled = false;
            loginButton.textContent = 'Entrar';
        }
    }

    async function recuperarContrasena() {
        const email = $('#login-email').value;
        const loginError = $('#login-error');

        if (!email) {
            loginError.textContent = 'Ingresa tu correo para poder enviar el enlace.';
            loginError.style.display = 'block';
            return;
        }

        showToast('Enviando correo de recuperaci√≥n...', 'info');
        loginError.style.display = 'none';
        
        try {
            await sendPasswordResetEmail(auth, email);
            showToast('‚úÖ Correo enviado. Revisa tu bandeja de entrada (y spam).', 'success');
        } catch (error) {
            console.error("Error al enviar correo:", error);
            if (error.code === 'auth/user-not-found') {
                loginError.textContent = 'No se encontr√≥ un usuario con ese correo.';
                loginError.style.display = 'block';
            } else {
                loginError.textContent = 'Ocurri√≥ un error al enviar el correo.';
                loginError.style.display = 'block';
            }
        }
    }

    async function cambiarContrasena() {
        const newPassword = $('#new-password').value;
        const confirmPassword = $('#confirm-password').value;
        const user = auth.currentUser;

        if (!user) {
            showToast('No has iniciado sesi√≥n.', 'error');
            return;
        }
        if (newPassword.length < 6) {
            showToast('La nueva contrase√±a debe tener al menos 6 caracteres.', 'error');
            return;
        }
        if (newPassword !== confirmPassword) {
            showToast('Las contrase√±as no coinciden.', 'error');
            return;
        }

        try {
            await updatePassword(user, newPassword);
            showToast('Contrase√±a actualizada correctamente.', 'success');
            $('#new-password').value = '';
            $('#confirm-password').value = '';
        } catch (error) {
            console.error("Error al cambiar la contrase√±a:", error);
            showToast('Error al actualizar. Es posible que necesites volver a iniciar sesi√≥n.', 'error');
        }
    }

    function paintAll() {
        paintDashboard();
        paintEmisor();
        refreshClientesSelect();
        updatePreviewCliente();
        updatePreviewClienteCotizacion();
        refreshProductosSelect();
        paintTablaClientes();
        paintTablaProductos();
        paintTablaFacturas();
        paintTablaCotizaciones();
    }
    
    function paintDashboard() {
      const paidInvoices = DB.Facturas.filter(f => f.status === 'Pagada');
      const pendingInvoices = DB.Facturas.filter(f => f.status !== 'Pagada' && f.status !== undefined);
      
      const totalPaid = paidInvoices.reduce((sum, inv) => sum + calcularTotal(inv), 0);
      const totalPending = pendingInvoices.reduce((sum, inv) => sum + calcularTotal(inv), 0);
      
      $('#stat-total-paid').textContent = currency(totalPaid);
      $('#stat-total-pending').textContent = currency(totalPending);
      $('#stat-total-clients').textContent = DB.Clientes.length;
      $('#stat-total-invoices').textContent = DB.Facturas.length;
      
      const recentActivity = [...DB.Facturas, ...DB.Cotizaciones]
          .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
          .slice(0, 5);
      
      const activityTbody = $('#tablaActividadReciente tbody');
      if (recentActivity.length === 0) {
          activityTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--muted);">No hay actividad reciente.</td></tr>';
          return;
      }
      activityTbody.innerHTML = recentActivity.map(doc => {
          const isInvoice = 'status' in doc;
          const type = isInvoice ? 'Factura' : 'Cotizaci√≥n';
          const cliente = DB.Clientes.find(c => c.nit === doc.clienteNit)?.nombre || 'N/A';
          return `
              <tr>
                  <td>${doc.numero}</td>
                  <td>${type} <span style="opacity: 0.5;">${isInvoice ? getStatusBadge(doc.status) : ''}</span></td>
                  <td>${cliente}</td>
                  <td class="right">${currency(calcularTotal(doc))}</td>
                  <td class="right">${doc.fecha}</td>
              </tr>
          `;
      }).join('');
    }
    
    function paintEmisor(){
      $('#em_nombre').value = DB.Emisor.nombre || '';
      $('#em_nit').value = DB.Emisor.nit || '';
      $('#em_dir').value = DB.Emisor.direccion || '';
      $('#em_tel').value = DB.Emisor.telefono || '';
      $('#em_mail').value = DB.Emisor.correo || '';
      $('#logoPreview').src = DB.Emisor.logo || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTQwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNDAiIGhlaWdodD0iODAiIGZpbGw9IiNGM0Y0RjYiIHJ4PSI4Ii8+PHN2ZyB4PSI1MCIgeT0iMjUiIHdpZHRoPSI0MCIgaGVpZHRoPSIzMCIgdmlld0JveD0iMCAwIDI0IDI4IiBmaWxsPSJub25lIiBzdHJva2U9IiM5Q0EwQUIiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTUgM0g2YTIgMiAwIDAgMC0yIDJ2MTRhMiAyIDAgMCAwIDIgMmgxMmEyIDIgMCAwIDAgMi0yVjlabTAgNGg0YTIgMiAwIDAgMSAyIDJ2MGEyIDIgMCAwIDEtMiAyaC00YTIgMiAwIDAgMS0yLTJ2MGEyIDIgMCAwIDEgMi0yeiIvPjwvc3ZnPjx0ZXh0IHg9IjcwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIiBmaWxsPSIjOUNBMEFCIj5Mb2dvIGRlIGxhIGVtcHJlc2E8L3RleHQ+PC9zdmc+';
    }
    function refreshClientesSelect(){
      const options = '<option value="">-- Seleccione un cliente --</option>' + DB.Clientes.map(c => `<option value="${c.nit}">${c.nombre} ‚Äî ${c.nit}</option>`).join('');
      $('#selCliente').innerHTML = options;
      $('#selClienteCotizacion').innerHTML = options;
    }
    function updatePreviewCliente(){
      const c = DB.Clientes.find(x => x.nit === $('#selCliente').value);
      $('#previewCliente').innerHTML = c ? `<b>${c.nombre}</b><br>${c.nit}<br>${c.direccion||''}<br>${c.telefono||''}<br>${c.correo||''}` : 'Seleccione un cliente.';
    }
    function updatePreviewClienteCotizacion(){
      const c = DB.Clientes.find(x => x.nit === $('#selClienteCotizacion').value);
      $('#previewClienteCotizacion').innerHTML = c ? `<b>${c.nombre}</b><br>${c.nit}<br>${c.direccion||''}<br>${c.telefono||''}<br>${c.correo||''}` : 'Seleccione un cliente.';
    }
    function refreshProductosSelect(){
      const options = DB.Productos.map(p => `<option value="${p.codigo}">${p.nombre} ‚Äî ${currency(p.valor)}</option>`).join('');
      $('#selProducto').innerHTML = options;
      $('#selProductoCotizacion').innerHTML = options;
    }
    function paintTablaClientes() {
        $('#tablaClientes tbody').innerHTML = DB.Clientes.map(c => `
            <tr>
                <td>${c.nombre}</td><td>${c.nit}</td><td>${c.telefono}</td><td>${c.correo}</td>
                <td class="right"><div class="table-actions"><button class="btn ghost btn-sm" data-action="edit" data-id="${c.id}">Editar</button><button class="btn danger btn-sm" data-action="delete" data-id="${c.id}">Borrar</button></div></td>
            </tr>`).join('');
    }
    function paintTablaProductos() {
        $('#tablaProductos tbody').innerHTML = DB.Productos.map(p => `
            <tr>
                <td>${p.codigo}</td><td>${p.nombre}</td><td>${currency(p.valor)}</td><td style="white-space:pre-line">${(p.bullets||[]).map(b => `‚Ä¢ ${b}`).join('\n')}</td>
                <td class="right"><div class="table-actions"><button class="btn ghost btn-sm" data-action="edit" data-id="${p.id}">Editar</button><button class="btn danger btn-sm" data-action="delete" data-id="${p.id}">Borrar</button></div></td>
            </tr>`).join('');
    }

    function paintTablaFacturas() {
        $('#tablaFacturas tbody').innerHTML = [...DB.Facturas].sort((a,b) => b.numero.localeCompare(a.numero)).map(f => `
            <tr>
                <td>${f.numero}</td><td>${f.fecha}</td><td>${DB.Clientes.find(c=>c.nit===f.clienteNit)?.nombre||'N/A'}</td><td class="right">${currency(calcularTotal(f))}</td>
                <td>${getStatusBadge(f.status)}</td>
                <td class="right">
                    <div class="table-actions">
                        <button class="btn ghost btn-sm" data-action="set-status" data-id="${f.id}" data-status="Pagada" title="Marcar como Pagada">‚úîÔ∏è Pagada</button>
                        <button class="btn ghost btn-sm" data-action="set-status" data-id="${f.id}" data-status="Enviada" title="Marcar como Enviada">‚úâÔ∏è Enviada</button>
                        <button class="btn primary btn-sm" data-action="download" data-id="${f.id}">PDF</button>
                        <button class="btn danger btn-sm" data-action="delete" data-id="${f.id}">Borrar</button>
                    </div>
                </td>
            </tr>`).join('');
    }

    function paintTablaCotizaciones() {
        $('#tablaCotizaciones tbody').innerHTML = [...DB.Cotizaciones].sort((a,b) => b.numero.localeCompare(a.numero)).map(c => `
            <tr>
                <td>${c.numero}</td><td>${c.fecha}</td><td>${DB.Clientes.find(cl=>cl.nit===c.clienteNit)?.nombre||'N/A'}</td><td class="right">${currency(calcularTotal(c))}</td>
                <td class="right">
                    <div class="table-actions">
                        <button class="btn success btn-sm" data-action="convert-to-invoice" data-id="${c.id}">Crear Factura</button>
                        <button class="btn primary btn-sm" data-action="download-quote" data-id="${c.id}">PDF</button>
                        <button class="btn danger btn-sm" data-action="delete-quote" data-id="${c.id}">Borrar</button>
                    </div>
                </td>
            </tr>`).join('');
    }

    function getStatusBadge(status) {
        switch (status) {
            case 'Pagada': return '<span class="badge badge-success">Pagada</span>';
            case 'Enviada': return '<span class="badge badge-info">Enviada</span>';
            case 'Vencida': return '<span class="badge badge-danger">Vencida</span>';
            default: return `<span class="badge badge-muted">${status || 'Borrador'}</span>`;
        }
    }

    function setupForms() {
      resetForm('factura');
      resetForm('cotizacion');
    }
    function generateDocumentNumber(type) {
        const year = new Date().getFullYear().toString().slice(-2);
        const prefix = type === 'factura' ? `FAC-${year}-` : `COT-${year}-`;
        let newNumber;
        let isUnique = false;
        const existingNumbers = type === 'factura' ? DB.Facturas.map(f => f.numero) : DB.Cotizaciones.map(c => c.numero);

        while (!isUnique) {
            const randomPart = Math.floor(100000 + Math.random() * 900000);
            newNumber = prefix + randomPart;
            if (!existingNumbers.includes(newNumber)) {
                isUnique = true;
            }
        }
        return newNumber;
    }
    function resetForm(type) {
        const isFactura = type === 'factura';
        const D = isFactura ? FACT : COTIZACION;
        const p = isFactura ? 'fc' : 'ct';

        Object.assign(D, { 
            numero: generateDocumentNumber(isFactura ? 'factura' : 'cotizacion'),
            fecha: today(), iva: 0, notas: '', items: [], 
            descuentoTipo: 'porcentaje', descuentoValor: 0 
        });
        
        $(`#${p}_num`).value = D.numero;
        $(`#${p}_fecha`).value = D.fecha;
        $(`#${p}_iva`).value = D.iva;
        $(`#${p}_notas`).value = '';
        $(`#selCliente${isFactura ? '' : 'Cotizacion'}`).value = '';
        $(`#${p}_desc_tipo`).value = 'porcentaje';
        $(`#${p}_desc_valor`).value = 0;
        
        paintItems(type);
        isFactura ? updatePreviewCliente() : updatePreviewClienteCotizacion();
    }
    function addItem(type) {
        const isFactura = type === 'factura';
        const D = isFactura ? FACT : COTIZACION;
        const cod = $(`#selProducto${isFactura ? '' : 'Cotizacion'}`).value;
        const cant = Math.max(1, Number($(`#selCantidad${isFactura ? '' : 'Cotizacion'}`).value) || 1);
        const p = DB.Productos.find(x => x.codigo === cod);
        if(!p) return showToast('Selecciona un producto', 'error');
        D.items.push({ ...p, cantidad: cant });
        paintItems(type);
    }
    function removeItem(type, index) {
        (type === 'factura' ? FACT : COTIZACION).items.splice(index, 1);
        paintItems(type);
    }
    window.removeItem = removeItem;
    function paintItems(type) {
        const isFactura = type === 'factura';
        const D = isFactura ? FACT : COTIZACION;
        const tbody = $(`#items${isFactura ? '' : 'Cotizacion'}`);
        tbody.innerHTML = D.items.map((it, i) => `
            <tr>
              <td>${it.codigo}</td><td>${it.nombre}</td><td style="white-space:pre-line">${(it.bullets||[]).map(b=>`‚Ä¢ ${b}`).join('\n')}</td>
              <td class="right">${it.cantidad}</td><td class="right">${currency(it.valor)}</td><td class="right">${currency(it.valor * it.cantidad)}</td>
              <td class="right"><button class="btn danger btn-sm btn-icon" onclick="removeItem('${type}', ${i})">‚úñ</button></td>
            </tr>`).join('');
        recalcTotals(type);
    }
    function recalcTotals(type) {
        const isFactura = type === 'factura';
        const D = isFactura ? FACT : COTIZACION;
        const p = isFactura ? 'fc' : 'ct';
        
        Object.assign(D, {
            iva: Number($(`#${p}_iva`).value) || 0, notas: $(`#${p}_notas`).value.trim(),
            fecha: $(`#${p}_fecha`).value || today(), descuentoTipo: $(`#${p}_desc_tipo`).value,
            descuentoValor: Number($(`#${p}_desc_valor`).value) || 0,
        });

        const subtotal = (D.items || []).reduce((a,b)=> a + (b.valor * b.cantidad), 0);
        const descuento = D.descuentoTipo === 'porcentaje' ? subtotal * (D.descuentoValor / 100) : D.descuentoValor;
        const iva = (subtotal - descuento) * (D.iva / 100);
        const total = subtotal - descuento + iva;

        $(`#subtotal${isFactura ? '' : 'Cotizacion'}`).textContent = currency(subtotal);
        $(`#descuento${isFactura ? '' : 'Cotizacion'}`).textContent = `- ${currency(descuento)}`;
        $(`#iva${isFactura ? '' : 'Cotizacion'}`).textContent = currency(iva);
        $(`#total${isFactura ? '' : 'Cotizacion'}`).textContent = currency(total);
    }
    
    function setupEventListeners() {
        const sidebar = $('.sidebar');
        const overlay = $('#sidebarOverlay');

        function toggleMenu() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        $('#mobileMenuButton').onclick = toggleMenu;
        overlay.onclick = toggleMenu;

        $$('.nav-link').forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                if (targetId) navigateTo(targetId);
                if (sidebar.classList.contains('active')) {
                    toggleMenu();
                }
            }
        });

        $('#btnNuevaFactura').onclick = () => resetForm('factura');
        $('#btnNuevaCotizacion').onclick = () => resetForm('cotizacion');
        $('#btnLimpiarFactura').onclick = () => resetForm('factura');
        $('#btnLimpiarCotizacion').onclick = () => resetForm('cotizacion');
        $('#btnAgregarItemFactura').onclick = () => addItem('factura');
        $('#btnAgregarItemCotizacion').onclick = () => addItem('cotizacion');
        $('#selCliente').onchange = updatePreviewCliente;
        $('#selClienteCotizacion').onchange = updatePreviewClienteCotizacion;
        ['#fc_iva', '#fc_notas', '#fc_fecha', '#fc_desc_tipo', '#fc_desc_valor'].forEach(id => $(id).addEventListener('input', () => recalcTotals('factura')));
        ['#ct_iva', '#ct_notas', '#ct_fecha', '#ct_desc_tipo', '#ct_desc_valor'].forEach(id => $(id).addEventListener('input', () => recalcTotals('cotizacion')));
        
        $('#btnNuevoCliente').onclick = () => {
            $('#modalClienteTitle').textContent = 'Agregar Cliente';
            $('#cl_edit_id').value = '';
            ['#cl_nombre','#cl_nit','#cl_dir','#cl_tel','#cl_mail'].forEach(id => $(id).value='');
            $('#cl_nit').disabled = false;
            $('#modalCliente').style.display='flex';
        };
        $('#tablaClientes').onclick = async (e) => {
            const btn = e.target.closest('button[data-id]');
            if (!btn) return;
            const id = btn.dataset.id;
            const action = btn.dataset.action;
            const cliente = DB.Clientes.find(c => c.id === id);
            if (!cliente) return;

            if (action === 'edit') {
                $('#modalClienteTitle').textContent = 'Editar Cliente';
                $('#cl_edit_id').value = cliente.id;
                $('#cl_nombre').value = cliente.nombre;
                $('#cl_nit').value = cliente.nit;
                $('#cl_nit').disabled = true;
                $('#cl_dir').value = cliente.direccion;
                $('#cl_tel').value = cliente.telefono;
                $('#cl_mail').value = cliente.correo;
                $('#modalCliente').style.display='flex';
            } else if (action === 'delete') {
                showConfirmacion(`¬øEliminar a ${cliente.nombre}?`, async () => {
                    await deleteDoc(doc(db, "Clientes", id));
                    await loadDB();
                });
            }
        };
        $('#btnGuardarCliente').onclick = async () => {
            const data = { 
                nombre: $('#cl_nombre').value.trim(), nit: $('#cl_nit').value.trim(),
                direccion: $('#cl_dir').value.trim(), telefono: $('#cl_tel').value.trim(), correo: $('#cl_mail').value.trim() 
            };
            if(!data.nombre || !data.nit) return showToast('Nombre y NIT son obligatorios', 'error');
            const id = $('#cl_edit_id').value;
            try {
                if (id) {
                    await setDoc(doc(db, "Clientes", id), data, { merge: true });
                } else {
                    if(DB.Clientes.some(x => x.nit === data.nit)) return showToast('Ese NIT ya existe', 'error');
                    await addDoc(collection(db, "Clientes"), data);
                }
                $('#modalCliente').style.display='none';
                await loadDB();
            } catch (e) { console.error(e); showToast('Error al guardar cliente', 'error'); }
        };

        $('#btnNuevoProducto').onclick = () => {
            $('#modalProductoTitle').textContent = 'Agregar Producto';
            $('#pr_edit_id').value = '';
            ['#pr_cod','#pr_nom','#pr_val','#pr_bullets'].forEach(id => $(id).value='');
            $('#pr_cod').disabled = false;
            $('#modalProducto').style.display='flex';
        };
        $('#tablaProductos').onclick = async (e) => {
            const btn = e.target.closest('button[data-id]');
            if (!btn) return;
            const id = btn.dataset.id;
            const action = btn.dataset.action;
            const producto = DB.Productos.find(p => p.id === id);
            if (!producto) return;

            if (action === 'edit') {
                $('#modalProductoTitle').textContent = 'Editar Producto';
                $('#pr_edit_id').value = producto.id;
                $('#pr_cod').value = producto.codigo;
                $('#pr_cod').disabled = true;
                $('#pr_nom').value = producto.nombre;
                $('#pr_val').value = producto.valor;
                $('#pr_bullets').value = (producto.bullets||[]).join('\n');
                $('#modalProducto').style.display='flex';
            } else if (action === 'delete') {
                showConfirmacion(`¬øEliminar ${producto.nombre}?`, async () => {
                    await deleteDoc(doc(db, "Productos", id));
                    await loadDB();
                });
            }
        };
        $('#btnGuardarProducto').onclick = async () => {
            const data = { 
                codigo: $('#pr_cod').value.trim(), nombre: $('#pr_nom').value.trim(),
                valor: Number($('#pr_val').value || 0),
                bullets: ($('#pr_bullets').value || '').split(/\n/).map(s=>s.replace(/^‚Ä¢\s?/,'').trim()).filter(Boolean)
            };
            if(!data.codigo || !data.nombre) return showToast('C√≥digo y nombre son obligatorios', 'error');
            const id = $('#pr_edit_id').value;
            try {
                if (id) {
                    await setDoc(doc(db, "Productos", id), data, { merge: true });
                } else {
                    if(DB.Productos.some(x => x.codigo === data.codigo)) return showToast('Ese c√≥digo ya existe', 'error');
                    await addDoc(collection(db, "Productos"), data);
                }
                $('#modalProducto').style.display='none';
                await loadDB();
            } catch (e) { console.error(e); showToast('Error al guardar producto', 'error'); }
        };

        $('#btnGuardarFactura').onclick = () => saveDocument('factura');
        $('#btnGuardarCotizacion').onclick = () => saveDocument('cotizacion');
        
        $('#btnPrintInvoice').onclick = () => handlePrintOrPdf('factura', true);
        $('#btnPrintQuote').onclick = () => handlePrintOrPdf('cotizacion', true);
        $('#btnEnviarFactura').onclick = () => handleEmail('factura');
        $('#btnEnviarCotizacion').onclick = () => handleEmail('cotizacion');

        $('#tablaFacturas').onclick = (e) => handleHistoryActions(e, 'factura');
        $('#tablaCotizaciones').onclick = (e) => handleHistoryActions(e, 'cotizacion');

        $('#btnGuardarEmisor').onclick = async () => {
            const data = {
                nombre: $('#em_nombre').value.trim(), nit: $('#em_nit').value.trim(),
                direccion: $('#em_dir').value.trim(), telefono: $('#em_tel').value.trim(),
                correo: $('#em_mail').value.trim(), logo: DB.Emisor.logo || ''
            };
            await setDoc(doc(db, "Configuracion", "Emisor"), data);
            DB.Emisor = data;
            showToast('Datos del emisor guardados', 'success');
        };
        $('#em_logo').onchange = async (e) => {
            const file = e.target.files?.[0]; if(!file) return;
            DB.Emisor.logo = await fileToDataURL(file);
            $('#logoPreview').src = DB.Emisor.logo;
            showToast('Logo listo. Pulsa "Guardar Emisor"', 'warning');
        };

        $('#btnPlantilla').onclick = downloadTemplateExcel;
        $('#btnImportExcel').onclick = () => $('#inputExcel').click();
        $('#inputExcel').onchange = importExcel;

        $('#btnConfirmarAccion').onclick = () => {
            if (confirmacionCallback) {
                confirmacionCallback();
                $('#modalConfirmacion').style.display = 'none';
                confirmacionCallback = null;
            }
        };

        $('#btnCambiarPassword').onclick = cambiarContrasena;
    }

    function showConfirmacion(mensaje, callback) {
        $('#modalConfirmacionMensaje').textContent = mensaje;
        $('#modalConfirmacion').style.display = 'flex';
        confirmacionCallback = callback;
    }

    function setupSearch() {
        $('#searchHistorial').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            filterTable('tablaFacturas', term);
            filterTable('tablaCotizaciones', term);
        });

        $('#searchClientes').addEventListener('input', (e) => {
            filterTable('tablaClientes', e.target.value.toLowerCase());
        });

        $('#searchProductos').addEventListener('input', (e) => {
            filterTable('tablaProductos', e.target.value.toLowerCase());
        });
    }

    function filterTable(tableId, term) {
        const rows = $(`#${tableId} tbody`).querySelectorAll('tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
        });
    }

    async function saveDocument(type) {
        const isFactura = type === 'factura';
        const D = isFactura ? FACT : COTIZACION;
        const collectionName = isFactura ? 'Facturas' : 'Cotizaciones';
        let nit = isFactura ? $('#selCliente').value : $('#selClienteCotizacion').value;
        if(D.items.length === 0 || !nit) return showToast('Agrega √≠tems y selecciona un cliente', 'error');
        
        recalcTotals(type);
        const docData = { ...D, clienteNit: nit, items: D.items.map(({id, ...rest}) => rest) }; 
        if (isFactura) {
            docData.status = 'Enviada';
        }
        
        try {
            const docRef = await addDoc(collection(db, collectionName), docData);
            showToast(`${isFactura ? 'Factura' : 'Cotizaci√≥n'} guardada`, 'success');
            await loadDB();
            
            const cliente = DB.Clientes.find(c => c.nit === nit);
            if (!cliente) return showToast('Cliente no encontrado para generar PDF', 'error');
            await generarPDF(docData, cliente, isFactura ? 'FACTURA' : 'COTIZACI√ìN', false);
        } catch(e) { 
            console.error("Error al guardar:", e);
            showToast('Error al guardar: ' + e.message, 'error'); 
        }
    }
    
    async function handleHistoryActions(event, type) {
        const btn = event.target.closest('button[data-id]');
        if (!btn) return;
        const id = btn.dataset.id;
        const action = btn.dataset.action.replace('-quote', '');
        const isFactura = type === 'factura';
        const docData = (isFactura ? DB.Facturas : DB.Cotizaciones).find(d => d.id === id);
        
        if (!docData) return;

        if (action === 'set-status' && isFactura) {
            const newStatus = btn.dataset.status;
            try {
                await updateDoc(doc(db, 'Facturas', id), { status: newStatus });
                showToast(`Factura marcada como ${newStatus}`, 'success');
                await loadDB();
            } catch(e) { showToast('Error al actualizar estado', 'error'); }
            return;
        }

        if (action === 'convert-to-invoice' && !isFactura) {
            const quoteData = DB.Cotizaciones.find(q => q.id === id);
            if (!quoteData) return showToast('Cotizaci√≥n no encontrada', 'error');
            
            resetForm('factura');
            Object.assign(FACT, {
                items: [...quoteData.items],
                iva: quoteData.iva,
                notas: `Basado en cotizaci√≥n: ${quoteData.numero}\n${quoteData.notas}`,
                descuentoTipo: quoteData.descuentoTipo,
                descuentoValor: quoteData.descuentoValor
            });
            $('#selCliente').value = quoteData.clienteNit;
            $('#fc_iva').value = FACT.iva;
            $('#fc_notas').value = FACT.notas;
            $('#fc_desc_tipo').value = FACT.descuentoTipo;
            $('#fc_desc_valor').value = FACT.descuentoValor;
            updatePreviewCliente();
            paintItems('factura');
            navigateTo('factura');
            showToast('Datos cargados. Revisa y guarda la nueva factura.', 'info');
            return;
        }

        if (action === 'delete') {
            showConfirmacion(`¬øEliminar ${isFactura ? 'factura' : 'cotizaci√≥n'} N¬∞ ${docData.numero}?`, async () => {
                await deleteDoc(doc(db, isFactura ? 'Facturas' : 'Cotizaciones', id));
                await loadDB();
            });
        } else if (action === 'download') {
            const cliente = DB.Clientes.find(c => c.nit === docData.clienteNit);
            if (!cliente) return showToast('Cliente no encontrado', 'error');
            try {
                await generarPDF(docData, cliente, isFactura ? 'FACTURA' : 'COTIZACI√ìN');
            } catch (e) {
                console.error("Error al generar PDF desde historial:", e);
                showToast('Error al generar PDF: ' + e.message, 'error');
            }
        }
    }
    
    function numeroALetras(num) {
      const unidades = ["", "uno", "dos", "tres", "cuatro", "cinco", "seis", "siete", "ocho", "nueve"];
      const decenas = ["", "diez", "veinte", "treinta", "cuarenta", "cincuenta", "sesenta", "setenta", "ochenta", "noventa"];
      const centenas = ["", "cien", "doscientos", "trescientos", "cuatrocientos", "quinientos", "seiscientos", "setecientos", "ochocientos", "novecientos"];
      function convertirMenor1000(n) {
        if (n === 0) return "";
        if (n < 10) return unidades[n];
        if (n < 100) {
          if (n < 20) {
            const especiales = { 10: "diez", 11: "once", 12: "doce", 13: "trece", 14: "catorce", 15: "quince", 16: "diecis√©is", 17: "diecisiete", 18: "dieciocho", 19: "diecinueve" };
            return especiales[n];
          }
          if (n % 10 === 0) return decenas[Math.floor(n / 10)];
          return decenas[Math.floor(n / 10)] + " y " + unidades[n % 10];
        }
        if (n < 1000) {
          if (n === 100) return "cien";
          if (n % 100 === 0) return centenas[Math.floor(n / 100)];
          return centenas[Math.floor(n / 100)] + " " + convertirMenor1000(n % 100);
        }
        return "";
      }
      if (num === 0) return "CERO PESOS M/CTE";
      let millones = Math.floor(num / 1000000);
      let miles = Math.floor((num % 1000000) / 1000);
      let resto = num % 1000;
      let texto = "";
      if (millones > 0) {
        if (millones === 1) texto += "un mill√≥n ";
        else texto += convertirMenor1000(millones) + " millones ";
      }
      if (miles > 0) {
        if (miles === 1) texto += "mil ";
        else texto += convertirMenor1000(miles) + " mil ";
      }
      if (resto > 0) { texto += convertirMenor1000(resto); }
      return (texto.trim() + " pesos m/cte").toUpperCase();
    }
    function downloadTemplateExcel(){
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([{ nombre: "Cliente Ejemplo", nit: "123456789", direccion: "Cra 1 #23-45", telefono: "3001234567", correo: "cliente@correo.com" }]), 'Clientes');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([{ codigo: "SRV-001", nombre: "Servicio de Consultor√≠a", valor: 120000, bullets: "An√°lisis inicial;Informe final" }]), 'Productos');
      XLSX.writeFile(wb, 'plantilla_importacion.xlsx');
    }
    async function importExcel(evt) {
        const file = evt.target.files?.[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const batch = writeBatch(db);

                let count = 0;
                const clientes = XLSX.utils.sheet_to_json(wb.Sheets['Clientes'] || {});
                clientes.forEach(c => {
                    if (c.nit && !DB.Clientes.some(db_c => db_c.nit === c.nit)) {
                        batch.set(doc(collection(db, "Clientes")), c);
                        count++;
                    }
                });
                const productos = XLSX.utils.sheet_to_json(wb.Sheets['Productos'] || {});
                productos.forEach(p => {
                    if (p.codigo && !DB.Productos.some(db_p => db_p.codigo === p.codigo)) {
                        batch.set(doc(collection(db, "Productos")), { ...p, bullets: String(p.bullets || '').split(';').map(s=>s.trim()).filter(Boolean) });
                        count++;
                    }
                });
                if (count > 0) {
                    await batch.commit();
                    showToast(`${count} registros importados. Actualizando...`, 'success');
                    await loadDB();
                } else {
                    showToast('No se encontraron nuevos registros para importar.', 'warning');
                }
            } catch (err) {
                console.error("Error al importar:", err);
                showToast("Error al procesar el archivo Excel.", 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }
    async function handlePrintOrPdf(type, autoPrint = false) {
        const isFactura = type === 'factura';
        const D = isFactura ? FACT : COTIZACION;
        if(D.items.length === 0) return showToast('Agrega al menos un √≠tem', 'error');
        
        let nit = isFactura ? $('#selCliente').value : $('#selClienteCotizacion').value;
        if(!nit) return showToast('Selecciona un cliente', 'error');
        const cliente = DB.Clientes.find(c => c.nit === nit);
        if(!cliente) return showToast('Cliente no v√°lido', 'error');
        
        await generarPDF(D, cliente, isFactura ? 'FACTURA' : 'COTIZACI√ìN', autoPrint);
    }
    function handleEmail(type) {
        const isFactura = type === 'factura';
        const D = isFactura ? FACT : COTIZACION;
        let nit = isFactura ? $('#selCliente').value : $('#selClienteCotizacion').value;
        if (!nit) return showToast('Selecciona un cliente primero.', 'error');
        
        const cliente = DB.Clientes.find(c => c.nit === nit);
        if (!cliente || !cliente.correo) return showToast('El cliente no tiene un correo electr√≥nico guardado.', 'error');

        const subject = `Env√≠o de ${isFactura ? 'Factura' : 'Cotizaci√≥n'} - ${D.numero}`;
        const body = `Estimado(a) ${cliente.nombre},\n\nAdjuntamos la ${isFactura ? 'factura' : 'cotizaci√≥n'} N¬∞ ${D.numero} correspondiente a nuestros servicios.\n\nQuedamos a su disposici√≥n para cualquier consulta.\n\nAtentamente,\nEl equipo de ${DB.Emisor.nombre}`;
        
        window.location.href = `mailto:${cliente.correo}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
    async function generarPDF(data, cliente, tipo, autoPrint = false) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const page = { w: doc.internal.pageSize.getWidth(), h: doc.internal.pageSize.getHeight(), m: 40 };
      const textColor = '#1a1c1e', mutedColor = '#6b7280', lineColor = '#e5e7eb', bgColor = '#f4f7fa';
      
      const addFooter = (yPos) => {
        doc.setFontSize(8); doc.setTextColor(mutedColor);
        doc.line(page.m, yPos - 10, page.w - page.m, yPos - 10);
        doc.text(`FACTURA PRO | WWW.CHOCOCREATIVO.COM.CO | 302 387 5061`, page.w / 2, yPos, { align: 'center' });
      };

      if (DB.Emisor.logo) { try { doc.addImage(DB.Emisor.logo, 'PNG', page.m, page.m, 100, 55, undefined, 'FAST'); } catch(e) { console.error("Error al cargar el logo", e); } }
      
      doc.setFont('helvetica', 'bold'); doc.setFontSize(26); doc.setTextColor(textColor);
      doc.text(tipo, page.w - page.m, page.m + 15, { align: 'right' });
      
      doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
      let emisorY = DB.Emisor.logo ? page.m + 70 : page.m;
      doc.setFont('helvetica', 'bold'); doc.text(DB.Emisor.nombre || 'Nombre Emisor', page.m, emisorY);
      doc.setFont('helvetica', 'normal'); doc.setTextColor(mutedColor);
      emisorY += 14; doc.text(`NIT: ${DB.Emisor.nit || ''}`, page.m, emisorY);
      emisorY += 14; doc.text(DB.Emisor.direccion || '', page.m, emisorY, { maxWidth: 200 });
      emisorY += 14; doc.text(`${DB.Emisor.correo || ''} ${DB.Emisor.telefono || ''}`, page.m, emisorY);
      
      const rightX = page.w - page.m;
      let factDataY = page.m + 45;
      doc.setFont('helvetica', 'bold'); doc.text(`N√∫mero de ${tipo}:`, rightX, factDataY, { align: 'right' });
      doc.setFont('helvetica', 'normal'); doc.text(data.numero, rightX, factDataY + 14, { align: 'right' });
      factDataY += 35; doc.setFont('helvetica', 'bold'); doc.text('Fecha:', rightX, factDataY, { align: 'right' });
      doc.setFont('helvetica', 'normal'); doc.text(data.fecha, rightX, factDataY + 14, { align: 'right' });

      let y = Math.max(emisorY, factDataY) + 40;
      doc.setDrawColor(lineColor); doc.line(page.m, y, page.w - page.m, y); y += 20;

      doc.setFontSize(10); doc.setTextColor(mutedColor); doc.text('CLIENTE:', page.m, y); y += 18;
      doc.setFontSize(12); doc.setFont('helvetica', 'bold'); doc.setTextColor(textColor); doc.text(cliente.nombre || '', page.m, y);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(10); doc.setTextColor(mutedColor);
      y += 14; doc.text(`NIT: ${cliente.nit || ''}`, page.m, y);
      y += 14; doc.text(cliente.direccion || '', page.m, y, { maxWidth: page.w / 2 - page.m });

      const body = (data.items || []).map(it => [it.codigo, it.nombre + '\n' + (it.bullets||[]).map(b=>`‚Ä¢ ${b}`).join('\n'), it.cantidad, currency(it.valor), currency(it.valor*it.cantidad)]);
      
      doc.autoTable({
        startY: y + 20,
        head: [['C√≥digo','Producto / Servicio','Cant.','V.Unit','Total']], body, theme: 'grid',
        styles: { fontSize: 9, cellPadding: 8, valign: 'middle' },
        headStyles: { fillColor: bgColor, textColor: textColor, fontStyle: 'bold', lineColor: lineColor, lineWidth: 1 },
        bodyStyles: { lineColor: lineColor },
        columnStyles: { 0: { cellWidth: 80 }, 2: { halign:'right', cellWidth: 50 }, 3: { halign:'right', cellWidth: 80 }, 4: { halign:'right', cellWidth: 90 } },
        didDrawPage: (data) => { addFooter(page.h - 15); }
      });

      let finalY = doc.lastAutoTable.finalY + 20;
      
      const qrContainer = $('#qrcode-container');
      qrContainer.innerHTML = '';
      
      const tot = calcularTotal(data);
      const qrData = `${tipo.slice(0, 3)}:${data.numero};T:${tot}`;
      
      try {
        new QRCode(qrContainer, { text: qrData, width: 80, height: 80, correctLevel: QRCode.CorrectLevel.L });
        await new Promise(resolve => setTimeout(resolve, 50));
        const qrCanvas = qrContainer.querySelector('canvas');
        if (qrCanvas) {
            doc.addImage(qrCanvas.toDataURL('image/png'), 'PNG', page.m, finalY, 70, 70);
        }
      } catch (qrError) { console.error("Error al generar QR:", qrError); }
      
      let leftY = finalY + 80;
      if (data.notas) {
          doc.setFont('helvetica', 'bold'); doc.setTextColor(textColor); doc.setFontSize(10);
          doc.text('Notas:', page.m, leftY);
          leftY += 15;
          doc.setFont('helvetica', 'normal'); doc.setTextColor(mutedColor);
          doc.text(data.notas, page.m, leftY, { maxWidth: 250 });
      }

      const sub = (data.items || []).reduce((a,b)=> a + b.valor*b.cantidad, 0);
      let descVal = data.descuentoTipo === 'porcentaje' ? sub * ((data.descuentoValor || 0) / 100) : (data.descuentoValor || 0);
      const ivaVal = (sub - descVal) * ((data.iva || 0)/100);
      const totalsX = page.w - page.m - 200;
      let rightY = doc.lastAutoTable.finalY + 20;

      doc.setFontSize(10); doc.text('Subtotal:', totalsX, rightY); doc.text(currency(sub), page.w - page.m, rightY, { align: 'right' });
      if (descVal > 0) {
        rightY += 20; doc.setTextColor(mutedColor);
        const descLabel = `Descuento (${data.descuentoTipo === 'porcentaje' ? `${data.descuentoValor || 0}%` : 'fijo'})`;
        doc.text(descLabel, totalsX, rightY);
        doc.setTextColor('#10b981'); doc.text(`- ${currency(descVal)}`, page.w - page.m, rightY, { align: 'right' }); doc.setTextColor(textColor);
      }
      rightY += 20; doc.text(`IVA (${data.iva || 0}%)`, totalsX, rightY); doc.text(currency(ivaVal), page.w - page.m, rightY, { align: 'right' });
      rightY += 10; doc.setDrawColor(lineColor); doc.line(totalsX - 10, rightY, page.w - page.m, rightY);
      rightY += 15; doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
      doc.text('TOTAL:', totalsX, rightY); doc.text(currency(tot), page.w - page.m, rightY, { align: 'right' });
      rightY += 20; doc.setFont('helvetica', 'normal'); doc.setFontSize(9); doc.setTextColor(mutedColor);
      doc.text("Son: " + numeroALetras(Math.round(tot)), totalsX, rightY, { maxWidth: 200 });

      finalY = page.h - 55;
      doc.setFontSize(7); doc.setTextColor(mutedColor);
      const legalText = `A esta factura de venta aplican las normas relativas a la letra de cambio (art√≠culo 5 Ley 1231 de 2008). Con esta el Comprador declara haber recibido real y materialmente las mercanc√≠as o prestaci√≥n de servicios descritos en este t√≠tulo - Valor. N√∫mero Autorizaci√≥n 18764077661980 aprobado en 20250822 prefijo FAC-25 desde el n√∫mero 200392 al 500000.`;
      doc.text(legalText, page.m, finalY, { maxWidth: page.w - (page.m * 2), align: 'justify' });
      
      if (autoPrint) {
          doc.autoPrint();
          window.open(doc.output('bloburl'), '_blank');
      } else {
          doc.save(`${tipo}_${data.numero}.pdf`);
          showToast('PDF generado correctamente', 'success');
      }
    }

    function fileToDataURL(file){
      return new Promise((res, rej) => { const r = new FileReader(); r.onload = ()=>res(r.result); r.onerror = rej; r.readAsDataURL(file); });
    }
    function currency(n){
      return (Number(n||0)).toLocaleString('es-CO', { style:'currency', currency:'COP', maximumFractionDigits: 0 });
    }
    function today(){ return new Date().toISOString().split('T')[0]; }
    
    function showToast(message, type = '') {
        const toast = $('#toast');
        toast.textContent = message;
        toast.className = 'toast show';
        if (type) toast.classList.add(type);
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
    function calcularTotal(doc) {
        const sub = (doc.items || []).reduce((a,b)=> a + (b.valor * b.cantidad), 0);
        const descVal = doc.descuentoTipo === 'porcentaje' ? sub * ((doc.descuentoValor || 0) / 100) : (doc.descuentoValor || 0);
        const subConDesc = sub - descVal;
        const ivaVal = subConDesc * ((doc.iva || 0) / 100);
        return subConDesc + ivaVal;
    }
    function navigateTo(pageId) {
        $$('.page').forEach(p => p.classList.remove('active'));
        $(`#page_${pageId}`).classList.add('active');
        $$('.nav-link').forEach(l => l.classList.remove('active'));
        $(`.nav-link[href="#${pageId}"]`).classList.add('active');
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        setupEventListeners();
        setupForms();

        const loginButton = $('#login-button');
        const passwordInput = $('#login-password');
        const emailInput = $('#login-email');
        const recoverButton = $('#recover-password-button');
        const loginError = $('#login-error');

        loginButton.onclick = intentarLogin;
        passwordInput.onkeypress = (e) => { if (e.key === 'Enter') intentarLogin(); };
        emailInput.onkeypress = (e) => { if (e.key === 'Enter') intentarLogin(); };
        recoverButton.onclick = recuperarContrasena;

        emailInput.oninput = () => loginError.style.display = 'none';
        passwordInput.oninput = () => loginError.style.display = 'none';

        $('#logout-button').onclick = async (e) => { 
            e.preventDefault(); 
            try {
                await firebase.signOut(auth);
                location.reload();
            } catch (error) { console.error("Error al cerrar sesi√≥n:", error); }
        };
    });
  </script>
</body>
</html>